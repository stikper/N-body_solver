import numpy as np
from src import (
    # Core
    ParticleData, G, AU,

    # Physics
    DirectForceCalculator,

    # Integrators
    LFIntegrator,

    # Simulation
    Simulation, SimulationParameters,

    # Visualization
    Animator2D, EnergyPlotter, RK4Integrator
)


def main():
    # ============================================
    # 1Ô∏è‚É£ –°–û–ó–î–ê–ù–ò–ï –°–û–õ–ù–ï–ß–ù–û–ô –°–ò–°–¢–ï–ú–´
    # ============================================

    # –ú–∞—Å—Å—ã –ø–ª–∞–Ω–µ—Ç (–≤ –∫–≥) - shape: (n, 1)
    masses = np.array([
        [1.989e30],  # –°–æ–ª–Ω—Ü–µ
        [3.285e23],  # –ú–µ—Ä–∫—É—Ä–∏–π
        [4.867e24],  # –í–µ–Ω–µ—Ä–∞
        [5.972e24],  # –ó–µ–º–ª—è
        [6.39e23],  # –ú–∞—Ä—Å
        [1.898e27],  # –Æ–ø–∏—Ç–µ—Ä
        [5.683e26],  # –°–∞—Ç—É—Ä–Ω
        [8.681e25],  # –£—Ä–∞–Ω
        [1.024e26],  # –ù–µ–ø—Ç—É–Ω
    ])

    # –ù–∞—á–∞–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ (–≤ –º–µ—Ç—Ä–∞—Ö) - –≤—Å–µ –ø–ª–∞–Ω–µ—Ç—ã –Ω–∞ –æ—Å–∏ X
    positions = np.array([
        [0.0, 0.0, 0.0],  # –°–æ–ª–Ω—Ü–µ –≤ —Ü–µ–Ω—Ç—Ä–µ
        [0.387 * AU, 0.0, 0.0],  # –ú–µ—Ä–∫—É—Ä–∏–π
        [0.723 * AU, 0.0, 0.0],  # –í–µ–Ω–µ—Ä–∞
        [1.000 * AU, 0.0, 0.0],  # –ó–µ–º–ª—è
        [1.524 * AU, 0.0, 0.0],  # –ú–∞—Ä—Å
        [5.203 * AU, 0.0, 0.0],  # –Æ–ø–∏—Ç–µ—Ä
        [9.537 * AU, 0.0, 0.0],  # –°–∞—Ç—É—Ä–Ω
        [19.191 * AU, 0.0, 0.0],  # –£—Ä–∞–Ω
        [30.069 * AU, 0.0, 0.0],  # –ù–µ–ø—Ç—É–Ω
    ])

    # –û—Ä–±–∏—Ç–∞–ª—å–Ω—ã–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ (–≤ –º/—Å) - –ø–æ –æ—Å–∏ Y –¥–ª—è –∫—Ä—É–≥–æ–≤—ã—Ö –æ—Ä–±–∏—Ç
    # v = sqrt(G * M_sun / r)
    velocities = np.array([
        [0.0, 0.0, 0.0],  # –°–æ–ª–Ω—Ü–µ –ø–æ–∫–æ–∏—Ç—Å—è
        [0.0, 47870.0, 0.0],  # –ú–µ—Ä–∫—É—Ä–∏–π
        [0.0, 35020.0, 0.0],  # –í–µ–Ω–µ—Ä–∞
        [0.0, 29780.0, 0.0],  # –ó–µ–º–ª—è
        [0.0, 24070.0, 0.0],  # –ú–∞—Ä—Å
        [0.0, 13070.0, 0.0],  # –Æ–ø–∏—Ç–µ—Ä
        [0.0, 9690.0, 0.0],  # –°–∞—Ç—É—Ä–Ω
        [0.0, 6810.0, 0.0],  # –£—Ä–∞–Ω
        [0.0, 5430.0, 0.0],  # –ù–µ–ø—Ç—É–Ω
    ])

    # –°–æ–∑–¥–∞—ë–º –æ–±—ä–µ–∫—Ç –¥–∞–Ω–Ω—ã—Ö
    data = ParticleData(
        masses=masses,
        positions=positions,
        velocities=velocities
    )

    # ============================================
    # 2Ô∏è‚É£ –ù–ê–°–¢–†–û–ô–ö–ê –ü–ê–†–ê–ú–ï–¢–†–û–í –°–ò–ú–£–õ–Ø–¶–ò–ò
    # ============================================

    # –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å–∏–ª
    force_calculator = DirectForceCalculator()

    # –ò–Ω—Ç–µ–≥—Ä–∞—Ç–æ—Ä (Leap-Frog - –ª—É—á—à–∏–π –¥–ª—è –æ—Ä–±–∏—Ç)
    integrator = RK4Integrator()

    # –®–∞–≥ –ø–æ –≤—Ä–µ–º–µ–Ω–∏: 1 –¥–µ–Ω—å = 86400 —Å–µ–∫—É–Ω–¥
    dt = 86400

    # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–∏–º—É–ª—è—Ü–∏–∏
    sim_params = SimulationParameters(
        force_calculator=force_calculator,
        integrator=integrator,
        dt=dt
    )

    # ============================================
    # 3Ô∏è‚É£ –ó–ê–ü–£–°–ö –°–ò–ú–£–õ–Ø–¶–ò–ò –ù–ê 10 –õ–ï–¢
    # ============================================

    # –°–æ–∑–¥–∞—ë–º —Å–∏–º—É–ª—è—Ü–∏—é
    sim = Simulation(data=data, sim_params=sim_params)

    # 10 –ª–µ—Ç = 10 * 365.25 –¥–Ω–µ–π
    years = 10
    n_steps = int(years * 365.25)

    print(f"üöÄ –ó–∞–ø—É—Å–∫ —Å–∏–º—É–ª—è—Ü–∏–∏ –°–æ–ª–Ω–µ—á–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –Ω–∞ {years} –ª–µ—Ç...")
    print(f"üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞–≥–æ–≤: {n_steps}")
    print(f"‚è±Ô∏è  –®–∞–≥ –≤—Ä–µ–º–µ–Ω–∏: {dt / 86400:.1f} –¥–Ω–µ–π\n")

    # –ú–∞—Å—Å–∏–≤—ã –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
    positions_history = np.zeros((n_steps, data.n_particles, 3))
    velocities_history = np.zeros((n_steps, data.n_particles, 3))
    times = np.zeros(n_steps)
    kinetic_energies = np.zeros(n_steps)
    potential_energies = np.zeros(n_steps)
    total_energies = np.zeros(n_steps)

    # –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª
    for i in range(n_steps):
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        positions_history[i] = sim.get_data().positions
        velocities_history[i] = sim.get_data().velocities
        times[i] = sim.time

        # –°—á–∏—Ç–∞–µ–º —ç–Ω–µ—Ä–≥–∏–∏
        kinetic_energies[i] = sim.system.calc_kinetic_energy()
        potential_energies[i] = sim.system.calc_potential_energy()
        total_energies[i] = sim.system.calc_total_energy()

        # –î–µ–ª–∞–µ–º —à–∞–≥ —Å–∏–º—É–ª—è—Ü–∏–∏
        sim.step()

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–∂–¥—ã–µ 365 —à–∞–≥–æ–≤ (—Ä–∞–∑ –≤ –≥–æ–¥)
        if i % 365 == 0:
            year = i / 365.25
            print(f"‚úì –ì–æ–¥ {year:.1f}/{years} –∑–∞–≤–µ—Ä—à—ë–Ω")

    print(f"\n‚úÖ –°–∏–º—É–ª—è—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n")

    # ============================================
    # 4Ô∏è‚É£ –ê–ù–ò–ú–ê–¶–ò–Ø –†–ï–ó–£–õ–¨–¢–ê–¢–û–í
    # ============================================

    # –ù–∞–∑–≤–∞–Ω–∏—è –∏ —Ü–≤–µ—Ç–∞ –ø–ª–∞–Ω–µ—Ç
    particle_names = [
        '‚òÄÔ∏è Sun',
        '–ú–µ—Ä–∫—É—Ä–∏–π',
        '–í–µ–Ω–µ—Ä–∞',
        'üåç –ó–µ–º–ª—è',
        '–ú–∞—Ä—Å',
        'ü™ê –Æ–ø–∏—Ç–µ—Ä',
        '–°–∞—Ç—É—Ä–Ω',
        '–£—Ä–∞–Ω',
        '–ù–µ–ø—Ç—É–Ω'
    ]

    particle_colors = [
        'yellow',  # –°–æ–ª–Ω—Ü–µ
        'gray',  # –ú–µ—Ä–∫—É—Ä–∏–π
        'orange',  # –í–µ–Ω–µ—Ä–∞
        'dodgerblue',  # –ó–µ–º–ª—è
        'red',  # –ú–∞—Ä—Å
        'sandybrown',  # –Æ–ø–∏—Ç–µ—Ä
        'gold',  # –°–∞—Ç—É—Ä–Ω
        'lightblue',  # –£—Ä–∞–Ω
        'blue'  # –ù–µ–ø—Ç—É–Ω
    ]

    # –°–æ–∑–¥–∞—ë–º –∞–Ω–∏–º–∞—Ç–æ—Ä
    animator = Animator2D(
        positions_history=positions_history,
        masses=masses,
        dt=dt,
        particle_names=particle_names,
        particle_colors=particle_colors,
        title='üåå –°–æ–ª–Ω–µ—á–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ - 10 –ª–µ—Ç',
        show_trails=True,
        trail_length=800,  # –î–ª–∏–Ω–∞ —Å–ª–µ–¥–∞ (–≤ –∫–∞–¥—Ä–∞—Ö)
        dark_theme=True,
    )

    print("üé¨ –ó–∞–ø—É—Å–∫ –∞–Ω–∏–º–∞—Ü–∏–∏...")
    print("üí° –ó–∞–∫—Ä–æ–π—Ç–µ –æ–∫–Ω–æ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –≥—Ä–∞—Ñ–∏–∫—É —ç–Ω–µ—Ä–≥–∏–∏\n")

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
    # interval=10 –æ–∑–Ω–∞—á–∞–µ—Ç 10 –º—Å –º–µ–∂–¥—É –∫–∞–¥—Ä–∞–º–∏ (100 FPS)
    animator.visualize(interval=10, repeat=True, show=True)

    # ============================================
    # 5Ô∏è‚É£ –ì–†–ê–§–ò–ö –≠–ù–ï–†–ì–ò–ò
    # ============================================

    print("\nüìà –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ —ç–Ω–µ—Ä–≥–∏–∏...")

    # –°–æ–∑–¥–∞—ë–º –≥—Ä–∞—Ñ–∏–∫ —ç–Ω–µ—Ä–≥–∏–∏
    energy_plotter = EnergyPlotter(
        times=times,
        kinetic_energies=kinetic_energies,
        potential_energies=potential_energies,
        total_energies=total_energies,
        title='‚ö° –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–∏ –≤ –°–æ–ª–Ω–µ—á–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ (10 –ª–µ—Ç)',
        dark_theme=True,
    )

    print("üí° –ó–∞–∫—Ä–æ–π—Ç–µ –æ–∫–Ω–æ –≥—Ä–∞—Ñ–∏–∫–∞ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã\n")

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ —Å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–π –æ—à–∏–±–∫–æ–π
    energy_plotter.visualize(show_relative_error=True, show=True)

    # –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫:
    # energy_plotter.save('solar_system_energy.png', dpi=300)
    # print("‚úÖ –ì—Ä–∞—Ñ–∏–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –∫–∞–∫ 'solar_system_energy.png'")

    # –í—ã—á–∏—Å–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —ç–Ω–µ—Ä–≥–∏–∏
    energy_drift = (total_energies[-1] - total_energies[0]) / total_energies[0] * 100
    print(f"\nüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —ç–Ω–µ—Ä–≥–∏–∏:")
    print(f"   –ù–∞—á–∞–ª—å–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è: {total_energies[0]:.6e} –î–∂")
    print(f"   –ö–æ–Ω–µ—á–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è:  {total_energies[-1]:.6e} –î–∂")
    print(f"   –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –¥—Ä–µ–π—Ñ: {energy_drift:.6f}%")

    if abs(energy_drift) < 0.01:
        print(f"   ‚úÖ –û—Ç–ª–∏—á–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–∏!")
    elif abs(energy_drift) < 0.1:
        print(f"   ‚úì –•–æ—Ä–æ—à–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–∏")
    else:
        print(f"   ‚ö†Ô∏è –ó–∞–º–µ—Ç–Ω—ã–π –¥—Ä–µ–π—Ñ —ç–Ω–µ—Ä–≥–∏–∏ (–ø–æ–ø—Ä–æ–±—É–π—Ç–µ —É–º–µ–Ω—å—à–∏—Ç—å dt)")

    print("\nüéâ –ü—Ä–æ–≥—Ä–∞–º–º–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")


if __name__ == '__main__':
    main()